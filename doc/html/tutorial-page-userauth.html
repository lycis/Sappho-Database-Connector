<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SapphoDatabaseConnection: Step 4: User Login</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">SapphoDatabaseConnection
   
   </div>
   <div id="projectbrief">A universal database connection interface for MySQL and postgreSQL</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('tutorial-page-userauth.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Step 4: User Login </div>  </div>
</div>
<div class="contents">
<div class="textblock"><p>This part of the tutorial focuses on the user login. We will use a session base connection, so it will be necessary for your webserver to provide this option.</p>
<p>The user authentication will be processed in a script called <code>login.php</code>. If you refer to the code in the second step where <code>index.php</code> was created you will notice that the login form we defined there uses the <code>login.php</code> as action.</p>
<h2><a class="anchor" id="tutorial-page-userauth-verify"></a>
Verifying user existence</h2>
<p>The first thing out login script has to do is to verify if the given user exists. if it does not we will prompt so. Before we can access the database we have to connect to it. Thanks to our <code>connect.php</code> that was created in the former step we can do this without much coding: </p>
<div class="fragment"><pre class="fragment"> &lt;?php
    require_once(<span class="stringliteral">&#39;connect.php&#39;</span>);
    ...
</pre></div><p>The connect script provides us with a database handle known as <code>$sdbc</code>. Now we will use this handle to execute a <code>SELECT</code> statement with a very basic where clause that will retrieve the user data.</p>
<h3><a class="anchor" id="tutorial-page-userauth-where"></a>
A simple WHERE clause</h3>
<p>The first step is to initialize a <code>WHERE</code> clause. All clauses and conditions of database statements are represented by <code>QueryOptions</code> (implemented in <code><a class="el" href="class_sappho_query_options.html" title="This class is used to set any statement options like WHERE clauses or ORDER BY etc.">SapphoQueryOptions</a></code>). Because each query options set is strongly tied to it's connection for reasons of data type recognition and formatting we use the <code>queryOptions()</code> method of the SDBC: </p>
<div class="fragment"><pre class="fragment">  $options = $sdbc-&gt;queryOptions()
                  -&gt;where(<span class="stringliteral">&#39;name&#39;</span>, <a class="code" href="class_sappho_query_options.html#a008c96da482d1a7b6bd8f24278ba8fc9">SapphoQueryOptions::EQUALS</a>, $_POST[<span class="stringliteral">&quot;username&quot;</span>]);
</pre></div><p> These two lines of code do two things: First the method <code>queryOptions()</code> initializes a new <a class="el" href="class_sappho_query_options.html" title="This class is used to set any statement options like WHERE clauses or ORDER BY etc.">SapphoQueryOptions</a> and binds it to the connection represented by <code>$sdbc</code>. Secondly we insert a new <code>WHERE</code> clause into the options. The layout of this method closely resembles the syntax you are possibly familiar with from various SQL dialects. The first parameter of <code> where(...)</code> is the name of the field we wish to compare. It is followed by the comparison operation. In this case this is <code>EQUALS</code> (shortcut <code>EQ</code>), indicating that we wat to check if the given field matches the third parameter of the function. Query options do of course support more than <code>EQUALS</code> for comparison, as we will see later on.</p>
<h3><a class="anchor" id="tutorial-page-userauth-escaping"></a>
A word on escaping</h3>
<p>You may wonder if we forgot to do some escaping in the example code above. Let me tell you we did not. It is a much too common mistake to forget proper escaping in <code>WHERE</code> clauses and so to open a gate to the hell of SQL injections.</p>
<p>By using the SDBC you won't have to worry about escaping most of the time. All major functions of the calss do the escaping based on the database type for you! Because of this it is not possible to inject malicious SQL code in the <code>WHERE</code> clause of the code above.</p>
<h3><a class="anchor" id="tutorial-page-userauth-select"></a>
The select statement</h3>
<p>Now that we have our statements options prepared we have to execute a select statement. This is very simply done by using the select(...) method of <a class="el" href="class_sappho_database_connection.html" title="This class handles connections to different database types. You&#39;ll probably want to use this one...">SapphoDatabaseConnection</a>: </p>
<div class="fragment"><pre class="fragment">  <span class="keywordflow">if</span>($sdbc-&gt;select(<span class="stringliteral">&#39;login&#39;</span>, <span class="charliteral">&#39;*&#39;</span>, $options))
    die(<span class="stringliteral">&quot;Could not verify user existence: &quot;</span>.$sdbc-&gt;lastError());
</pre></div><p> By calling the method we create and execute a <code>SELECT</code> on the table <code>login</code> with the query options we configured beforehand. The method will return 0 (zero) if everything worked out and anything greater 0 if it did not. So by applying the <code>if</code> condition check we will exit with a proper error message in case something was wrong. The <code>lastError</code> method directly returns the last error we received from the database system.</p>
<h3><a class="anchor" id="tutorial-page-userauth-count"></a>
Counting the rows</h3>
<p>Finally, to verify if the user exists, we will count the returned rows. If we no row was selected a user with this name obviously does not exist. We can count the returned rows by using <code>rowCount()</code>. The method simply returns the amount of rows affected by the last statement: </p>
<div class="fragment"><pre class="fragment">  <span class="keywordflow">if</span>($sdbc-&gt;rowCount() &lt; 1)
        die(<span class="stringliteral">&quot;This user does not exist.&quot;</span>);
</pre></div><h2><a class="anchor" id="tutorial-page-userauth-password"></a>
Checking the password</h2>
<p>By using the <code>select(...)</code> method we already have received a valid result set (of course only if the select returned no error). So we are able to access the selected rows by using the <code>nextData()</code> method of our database handle. This method always returns a associative array that contains the next row of the selected data: </p>
<div class="fragment"><pre class="fragment">  $user = $sdbc-&gt;nextData();
  <span class="keywordflow">if</span>($_POST[<span class="stringliteral">&quot;password&quot;</span>] != $user[<span class="stringliteral">&quot;password&quot;</span>])
    die(<span class="stringliteral">&quot;No, that&#39;s not the password!&quot;</span>);
</pre></div><p>If the user entered a correct user name and password we will mark the session as logged in and provide the user with a link back to our mainpage. </p>
<div class="fragment"><pre class="fragment">    echo <span class="stringliteral">&quot;Login successful.&lt;br/&gt;&quot;</span>;
    $_SESSION[<span class="stringliteral">&quot;loggedin&quot;</span>] = <span class="keyword">true</span>;
    echo <span class="stringliteral">&quot;&lt;a href=&#39;index.php&#39;&gt;Click here to continue&lt;/a&gt;&quot;</span>;
    
    ?&gt;
</pre></div> </div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="index.html">index</a>      </li>
      <li class="navelem"><a class="el" href="tutorial-page-main.html">Tutorial</a>      </li>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


    <li class="footer">Generated on Thu Nov 3 2011 15:45:43 for SapphoDatabaseConnection by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
